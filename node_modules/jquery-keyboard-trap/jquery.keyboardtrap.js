/**
* @function jquery.keyboardtrap.js
* @version 0.1.3
* @author Ian McBurnie <imcburnie@ebay.com>
* @desc Traps keyboard focus cycle within element's interactive children.
* Does not trap mouse focus! i.e. it does not prevent mouse user from clicking
* outside of keyboard trap to set focus elsewhere - by default the trap will
* be deactivated in this case.
* @requires jquery-focusable
* @requires jquery-focus-exit
* @param {options}
* @param {boolean} options.deactivateOnFocusExit - deactivate focus trap when
* mouse user interacts with rest of page.
*/
(function ($, window, document, undefined) {

    var trapTemplate = '<div tabindex="0" class="keyboard-trap-boundary">',
        defaults = { deactivateOnFocusExit: true },
        $outerTrapBefore = $(trapTemplate),
        $innerTrapBefore = $(trapTemplate),
        $innerTrapAfter = $(trapTemplate),
        $outerTrapAfter = $(trapTemplate),
        $trap,
        $firstTabElement,
        $lastTabElement;

    $outerTrapBefore.on('focus', setFocusToFirstFocusableElement);
    $innerTrapBefore.on('focus', setFocusToLastFocusableElement);
    $innerTrapAfter.on('focus', setFocusToFirstFocusableElement);
    $outerTrapAfter.on('focus', setFocusToLastFocusableElement);

    function setFocusToFirstFocusableElement(){
        $firstTabElement.focus();
    }

    function setFocusToLastFocusableElement(){
        $lastTabElement.focus();
    }

    $.trapKeyboard = function trapKeyboard(el, options) {
        var opts = $.extend({}, defaults, options),
            $focusable;

        $.untrapKeyboard();

        $trap = $(el);
        $focusable = $trap.focusable();
        $firstTabElement = $focusable.first();
        $lastTabElement = $focusable.last();

        if (opts.deactivateOnFocusExit === true) {
            $trap.focusExit();

            $trap.one('focusexit', function(e) {
                if (opts.deactivateOnFocusExit === true) {
                    $.untrapKeyboard();
                }
            });
        }

        $outerTrapBefore.insertBefore($trap);
        $trap.prepend($innerTrapBefore);
        $trap.append($innerTrapAfter);
        $outerTrapAfter.insertAfter($trap);

        $trap.addClass('keyboard-trap--active');
        $trap.trigger('on.keyboardTrap');

        return $trap;
    };

    $.untrapKeyboard = function untrapKeyboard() {
        if ($trap !== undefined) {
            $outerTrapBefore.detach();
            $innerTrapBefore.detach();
            $innerTrapAfter.detach();
            $outerTrapAfter.detach();

            $trap.off('focusexit');
            $trap.removeClass('keyboard-trap--active');
            $trap.trigger('off.keyboardTrap');
        }
        return $trap;
    };

}(jQuery, window, document));
